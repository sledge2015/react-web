// pages/Dashboard/index.tsximport React, { useState, useEffect } from 'react';import { useAuth } from '../../hooks/useAuth';import { AdminPanel } from '../../components/AdminPanel';import { stockService, UserStock } from '../../services/stockService';import './Dashboard.css';// æ•°æ®é¡¹ç±»å‹å®šä¹‰ - åŸºäºAPIå“åº”interface DataItem {  id: string;  symbol: string;           // è‚¡ç¥¨ä»£ç   companyName: string;      // å…¬å¸åç§°  price: number;            // å½“å‰ä»·æ ¼  change: number;           // æ¶¨è·Œé¢  changePercent: number;    // æ¶¨è·Œå¹…  volume: number;           // æˆäº¤é‡  marketCap: number;        // å¸‚å€¼  lastUpdated: string;      // æœ€åæ›´æ–°æ—¶é—´}export const Dashboard: React.FC = () => {  const { user, logout, isAdmin } = useAuth();  const [items, setItems] = useState<DataItem[]>([]);  const [isLoading, setIsLoading] = useState(false);  const [isAdding, setIsAdding] = useState(false);  const [searchTerm, setSearchTerm] = useState('');  const [sortBy, setSortBy] = useState<keyof DataItem>('symbol');  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('asc');  // ä½¿ç”¨å¸ƒå°”å€¼æ¥æ§åˆ¶è§†å›¾ï¼Œé¿å…TypeScriptç±»å‹æ¯”è¾ƒé—®é¢˜  const [showAdminPanel, setShowAdminPanel] = useState(false);  const [error, setError] = useState<string | null>(null);  // è·å–è‚¡ç¥¨æ•°æ®  const fetchStockData = async () => {    setIsLoading(true);    setError(null);    try {      // ä¼˜å…ˆä»APIè·å–æ•°æ®      const userStocks = await stockService.getUserStocks();      // è½¬æ¢APIæ•°æ®æ ¼å¼ä¸ºç»„ä»¶æ‰€éœ€æ ¼å¼      const transformedData: DataItem[] = userStocks.map((userStock: UserStock) => ({        id: userStock.id,        symbol: userStock.stock.symbol,        companyName: userStock.stock.companyName,        price: userStock.stock.price,        change: userStock.stock.change,        changePercent: userStock.stock.changePercent,        volume: userStock.stock.volume,        marketCap: userStock.stock.marketCap,        lastUpdated: userStock.stock.lastUpdated,      }));      setItems(transformedData);    } catch (error) {      console.error('è·å–è‚¡ç¥¨æ•°æ®å¤±è´¥:', error);      setError('è·å–è‚¡ç¥¨æ•°æ®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');      // APIå¤±è´¥æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºåå¤‡æ–¹æ¡ˆ      const mockData: DataItem[] = [        {          id: 'mock-1',          symbol: 'AAPL',          companyName: 'Apple Inc.',          price: 150.25,          change: 2.15,          changePercent: 1.45,          volume: 50000000,          marketCap: 2500000000000,          lastUpdated: new Date().toISOString(),        },        {          id: 'mock-2',          symbol: 'GOOGL',          companyName: 'Alphabet Inc.',          price: 2750.80,          change: -15.20,          changePercent: -0.55,          volume: 25000000,          marketCap: 1800000000000,          lastUpdated: new Date().toISOString(),        },        {          id: 'mock-3',          symbol: 'TSLA',          companyName: 'Tesla, Inc.',          price: 850.45,          change: 12.30,          changePercent: 1.47,          volume: 45000000,          marketCap: 850000000000,          lastUpdated: new Date().toISOString(),        }      ];      setItems(mockData);    } finally {      setIsLoading(false);    }  };  // æ·»åŠ è‚¡ç¥¨åˆ°ç›‘æ§åˆ—è¡¨  const addStock = async (symbol: string) => {    try {      setError(null);      const userStock = await stockService.addUserStock(symbol);      // å°†æ–°æ·»åŠ çš„è‚¡ç¥¨è½¬æ¢ä¸ºç»„ä»¶æ ¼å¼å¹¶æ·»åŠ åˆ°åˆ—è¡¨      const newItem: DataItem = {        id: userStock.id,        symbol: userStock.stock.symbol,        companyName: userStock.stock.companyName,        price: userStock.stock.price,        change: userStock.stock.change,        changePercent: userStock.stock.changePercent,        volume: userStock.stock.volume,        marketCap: userStock.stock.marketCap,        lastUpdated: userStock.stock.lastUpdated,      };      setItems(prev => [...prev, newItem]);    } catch (error) {      console.error('æ·»åŠ è‚¡ç¥¨å¤±è´¥:', error);      setError('æ·»åŠ è‚¡ç¥¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç æ˜¯å¦æ­£ç¡®');      // APIå¤±è´¥æ—¶åˆ›å»ºæ¨¡æ‹Ÿæ•°æ®      const mockItem: DataItem = {        id: `mock-${Date.now()}`,        symbol: symbol.toUpperCase(),        companyName: `${symbol.toUpperCase()} Company`,        price: Math.random() * 1000 + 50,        change: (Math.random() - 0.5) * 20,        changePercent: (Math.random() - 0.5) * 5,        volume: Math.floor(Math.random() * 100000000),        marketCap: Math.floor(Math.random() * 1000000000000),        lastUpdated: new Date().toISOString(),      };      setItems(prev => [...prev, mockItem]);    }  };  // åˆ é™¤è‚¡ç¥¨  const removeStock = async (id: string) => {    try {      setError(null);      await stockService.removeUserStock(id);      setItems(prev => prev.filter(item => item.id !== id));    } catch (error) {      console.error('åˆ é™¤è‚¡ç¥¨å¤±è´¥:', error);      setError('åˆ é™¤è‚¡ç¥¨å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');      // å³ä½¿APIå¤±è´¥ï¼Œä¹Ÿä»æœ¬åœ°åˆ—è¡¨ä¸­ç§»é™¤      setItems(prev => prev.filter(item => item.id !== id));    }  };  // åˆ·æ–°è‚¡ç¥¨æ•°æ®ï¼ˆè·å–æœ€æ–°æŠ¥ä»·ï¼‰  const refreshStockPrices = async () => {    if (items.length === 0) return;    try {      setError(null);      const symbols = items.map(item => item.symbol);      const quotes = await stockService.getBatchQuotes(symbols);      // æ›´æ–°ä»·æ ¼æ•°æ®      setItems(prev => prev.map(item => {        const quote = quotes.find(q => q.symbol === item.symbol);        return quote ? {          ...item,          price: quote.price,          change: quote.change,          changePercent: quote.changePercent,          volume: quote.volume,          lastUpdated: quote.timestamp,        } : item;      }));    } catch (error) {      console.error('åˆ·æ–°è‚¡ç¥¨ä»·æ ¼å¤±è´¥:', error);      // é™é»˜å¤±è´¥ï¼Œä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯    }  };  // å¤„ç†æ’åº  const handleSort = (field: keyof DataItem) => {    if (sortBy === field) {      setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');    } else {      setSortBy(field);      setSortOrder('asc');    }  };  // è¿‡æ»¤å’Œæ’åºæ•°æ®  const filteredAndSortedItems = items    .filter(item =>      item.symbol.toLowerCase().includes(searchTerm.toLowerCase()) ||      item.companyName.toLowerCase().includes(searchTerm.toLowerCase())    )    .sort((a, b) => {      const aValue = a[sortBy];      const bValue = b[sortBy];      if (typeof aValue === 'string' && typeof bValue === 'string') {        return sortOrder === 'asc'          ? aValue.localeCompare(bValue)          : bValue.localeCompare(aValue);      }      if (typeof aValue === 'number' && typeof bValue === 'number') {        return sortOrder === 'asc' ? aValue - bValue : bValue - aValue;      }      return 0;    });  // æ ¼å¼åŒ–æ•°å­—  const formatNumber = (num: number, decimals: number = 2): string => {    return new Intl.NumberFormat('en-US', {      minimumFractionDigits: decimals,      maximumFractionDigits: decimals,    }).format(num);  };  // æ ¼å¼åŒ–å¸‚å€¼  const formatMarketCap = (marketCap: number): string => {    if (marketCap >= 1e12) {      return `${formatNumber(marketCap / 1e12, 1)}T`;    } else if (marketCap >= 1e9) {      return `${formatNumber(marketCap / 1e9, 1)}B`;    } else if (marketCap >= 1e6) {      return `${formatNumber(marketCap / 1e6, 1)}M`;    }    return `${formatNumber(marketCap)}`;  };  // æ ¼å¼åŒ–æ—¶é—´  const formatTime = (timestamp: string) => {    return new Date(timestamp).toLocaleString('zh-CN', {      month: '2-digit',      day: '2-digit',      hour: '2-digit',      minute: '2-digit',    });  };  useEffect(() => {    if (!showAdminPanel) {      fetchStockData();      // è®¾ç½®å®šæ—¶åˆ·æ–°è‚¡ç¥¨ä»·æ ¼      const priceRefreshInterval = setInterval(refreshStockPrices, 30000); // 30ç§’åˆ·æ–°ä»·æ ¼      const dataRefreshInterval = setInterval(fetchStockData, 300000); // 5åˆ†é’Ÿåˆ·æ–°å®Œæ•´æ•°æ®      return () => {        clearInterval(priceRefreshInterval);        clearInterval(dataRefreshInterval);      };    }  }, [showAdminPanel, items.length]);  // å¦‚æœå½“å‰è§†å›¾æ˜¯ç®¡ç†å‘˜é¢æ¿ï¼Œæ¸²æŸ“ç®¡ç†å‘˜é¢æ¿  if (showAdminPanel) {    return <AdminPanel />;  }  return (    <div className="dashboard">      {/* å¤´éƒ¨ */}      <header className="dashboard-header">        <div className="header-left">          <h1>ç¾è‚¡æŠ•èµ„ç›‘æ§å°</h1>          <p>æ¬¢è¿å›æ¥ï¼Œ{user?.username}ï¼{user?.role === 'admin' && ' (ç®¡ç†å‘˜)'}</p>        </div>        <div className="header-right">          <div className="view-switcher">            <button              className={`view-btn ${!showAdminPanel ? 'active' : ''}`}              onClick={() => setShowAdminPanel(false)}            >              ğŸ“ˆ è‚¡ç¥¨ç›‘æ§            </button>            {isAdmin() && (              <button                className={`view-btn ${showAdminPanel ? 'active' : ''}`}                onClick={() => setShowAdminPanel(true)}              >                âš™ï¸ ç®¡ç†é¢æ¿              </button>            )}          </div>          <button            className="refresh-btn"            onClick={fetchStockData}            disabled={isLoading}            title="åˆ·æ–°è‚¡ç¥¨æ•°æ®"          >            {isLoading ? 'åˆ·æ–°ä¸­...' : 'ğŸ”„ åˆ·æ–°'}          </button>          <button className="logout-btn" onClick={logout}>            ç™»å‡º          </button>        </div>      </header>      {/* é”™è¯¯æç¤º */}      {error && (        <div className="error-banner">          <span className="error-icon">âš ï¸</span>          <span className="error-message">{error}</span>          <button            className="error-close"            onClick={() => setError(null)}            aria-label="å…³é—­é”™è¯¯æç¤º"          >            Ã—          </button>        </div>      )}      {/* å·¥å…·æ  */}      <div className="toolbar">        <div className="search-container">          <input            type="text"            placeholder="æœç´¢è‚¡ç¥¨ä»£ç æˆ–å…¬å¸åç§°..."            value={searchTerm}            onChange={(e) => setSearchTerm(e.target.value)}            className="search-input"          />        </div>        <div className="toolbar-actions">          <button            className="refresh-prices-btn"            onClick={refreshStockPrices}            disabled={items.length === 0}            title="åˆ·æ–°è‚¡ç¥¨ä»·æ ¼"          >            ğŸ’± åˆ·æ–°ä»·æ ¼          </button>          <button            className="add-stock-btn"            onClick={() => setIsAdding(true)}          >            â• æ·»åŠ è‚¡ç¥¨          </button>        </div>      </div>      {/* æŠ•èµ„ç»„åˆæ¦‚è§ˆ */}      {items.length > 0 && (        <div className="portfolio-overview">          <div className="overview-card">            <h3>æŠ•èµ„ç»„åˆæ¦‚è§ˆ</h3>            <div className="overview-stats">              <div className="stat-item">                <span className="stat-label">æŒæœ‰è‚¡ç¥¨</span>                <span className="stat-value">{items.length}</span>              </div>              <div className="stat-item">                <span className="stat-label">æ€»å¸‚å€¼</span>                <span className="stat-value">                  {formatMarketCap(items.reduce((sum, item) => sum + item.marketCap, 0))}                </span>              </div>              <div className="stat-item">                <span className="stat-label">å¹³å‡æ¶¨è·Œå¹…</span>                <span className={`stat-value ${items.reduce((sum, item) => sum + item.changePercent, 0) / items.length >= 0 ? 'positive' : 'negative'}`}>                  {formatNumber(items.reduce((sum, item) => sum + item.changePercent, 0) / items.length)}%                </span>              </div>              <div className="stat-item">                <span className="stat-label">æœ€åæ›´æ–°</span>                <span className="stat-value">                  {items.length > 0 ? formatTime(items[0].lastUpdated) : '--'}                </span>              </div>            </div>          </div>        </div>      )}      {/* è‚¡ç¥¨åˆ—è¡¨ */}      <div className="stock-table-container">        {isLoading && items.length === 0 ? (          <div className="loading-message">            <div className="loading-spinner"></div>            <p>æ­£åœ¨åŠ è½½è‚¡ç¥¨æ•°æ®...</p>          </div>        ) : (          <table className="stock-table">            <thead>              <tr>                <th onClick={() => handleSort('symbol')} className="sortable">                  è‚¡ç¥¨ä»£ç  {sortBy === 'symbol' && (sortOrder === 'asc' ? 'â†‘' : 'â†“')}                </th>                <th onClick={() => handleSort('companyName')} className="sortable">                  å…¬å¸åç§° {sortBy === 'companyName' && (sortOrder === 'asc' ? 'â†‘' : 'â†“')}                </th>                <th onClick={() => handleSort('price')} className="sortable">                  å½“å‰ä»·æ ¼ {sortBy === 'price' && (sortOrder === 'asc' ? 'â†‘' : 'â†“')}                </th>                <th onClick={() => handleSort('change')} className="sortable">                  æ¶¨è·Œé¢ {sortBy === 'change' && (sortOrder === 'asc' ? 'â†‘' : 'â†“')}                </th>                <th onClick={() => handleSort('changePercent')} className="sortable">                  æ¶¨è·Œå¹… {sortBy === 'changePercent' && (sortOrder === 'asc' ? 'â†‘' : 'â†“')}                </th>                <th onClick={() => handleSort('volume')} className="sortable">                  æˆäº¤é‡ {sortBy === 'volume' && (sortOrder === 'asc' ? 'â†‘' : 'â†“')}                </th>                <th onClick={() => handleSort('marketCap')} className="sortable">                  å¸‚å€¼ {sortBy === 'marketCap' && (sortOrder === 'asc' ? 'â†‘' : 'â†“')}                </th>                <th onClick={() => handleSort('lastUpdated')} className="sortable">                  æ›´æ–°æ—¶é—´ {sortBy === 'lastUpdated' && (sortOrder === 'asc' ? 'â†‘' : 'â†“')}                </th>                <th>æ“ä½œ</th>              </tr>            </thead>            <tbody>              {filteredAndSortedItems.map((item) => (                <tr key={item.id} className="stock-row">                  <td className="symbol">                    <span className="symbol-text">{item.symbol}</span>                  </td>                  <td className="company-name" title={item.companyName}>                    {item.companyName}                  </td>                  <td className="price">                    ${formatNumber(item.price)}                  </td>                  <td className={`change ${item.change >= 0 ? 'positive' : 'negative'}`}>                    {item.change >= 0 ? '+' : ''}${formatNumber(item.change)}                  </td>                  <td className={`change-percent ${item.changePercent >= 0 ? 'positive' : 'negative'}`}>                    {item.changePercent >= 0 ? '+' : ''}{formatNumber(item.changePercent)}%                  </td>                  <td className="volume">                    {formatNumber(item.volume, 0)}                  </td>                  <td className="market-cap">                    {formatMarketCap(item.marketCap)}                  </td>                  <td className="last-updated">                    {formatTime(item.lastUpdated)}                  </td>                  <td className="actions">                    <button                      className="remove-btn"                      onClick={() => removeStock(item.id)}                      title={`ç§»é™¤ ${item.symbol}`}                    >                      ğŸ—‘ï¸ ç§»é™¤                    </button>                  </td>                </tr>              ))}            </tbody>          </table>        )}        {filteredAndSortedItems.length === 0 && !isLoading && (          <div className="empty-message">            <div className="empty-icon">ğŸ“ˆ</div>            <h3>              {searchTerm ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è‚¡ç¥¨' : 'æš‚æ— ç›‘æ§çš„è‚¡ç¥¨'}            </h3>            <p>              {searchTerm                ? 'å°è¯•ä¿®æ”¹æœç´¢æ¡ä»¶æˆ–æ¸…ç©ºæœç´¢æ¡†æŸ¥çœ‹æ‰€æœ‰è‚¡ç¥¨'                : 'ç‚¹å‡»"æ·»åŠ è‚¡ç¥¨"æŒ‰é’®å¼€å§‹ç›‘æ§æ‚¨æ„Ÿå…´è¶£çš„è‚¡ç¥¨'              }            </p>            {!searchTerm && (              <button                className="add-stock-btn primary"                onClick={() => setIsAdding(true)}              >                â• æ·»åŠ ç¬¬ä¸€åªè‚¡ç¥¨              </button>            )}          </div>        )}      </div>      {/* æ·»åŠ è‚¡ç¥¨æ¨¡æ€æ¡† */}      {isAdding && (        <AddStockModal          onAdd={addStock}          onClose={() => setIsAdding(false)}        />      )}    </div>  );};// æ·»åŠ è‚¡ç¥¨æ¨¡æ€æ¡†ç»„ä»¶interface AddStockModalProps {  onAdd: (symbol: string) => void;  onClose: () => void;}const AddStockModal: React.FC<AddStockModalProps> = ({ onAdd, onClose }) => {  const [symbol, setSymbol] = useState('');  const [isSearching, setIsSearching] = useState(false);  const [searchResults, setSearchResults] = useState<any[]>([]);  const [error, setError] = useState('');  // æœç´¢è‚¡ç¥¨  const searchStocks = async (query: string) => {    if (query.length < 2) {      setSearchResults([]);      return;    }    setIsSearching(true);    setError('');    try {      const results = await stockService.searchStocks(query);      setSearchResults(results.slice(0, 10)); // é™åˆ¶æ˜¾ç¤º10ä¸ªç»“æœ    } catch (error) {      console.error('æœç´¢è‚¡ç¥¨å¤±è´¥:', error);      setError('æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');      setSearchResults([]);    } finally {      setIsSearching(false);    }  };  // é˜²æŠ–æœç´¢  useEffect(() => {    const timer = setTimeout(() => {      searchStocks(symbol);    }, 300);    return () => clearTimeout(timer);  }, [symbol]);  const handleSubmit = (e: React.FormEvent) => {    e.preventDefault();    if (symbol.trim()) {      onAdd(symbol.toUpperCase().trim());      onClose();    }  };  const handleSelectStock = (selectedSymbol: string) => {    onAdd(selectedSymbol);    onClose();  };  return (    <div className="modal-overlay" onClick={onClose}>      <div className="modal-content add-stock-modal" onClick={(e) => e.stopPropagation()}>        <div className="modal-header">          <h3>æ·»åŠ è‚¡ç¥¨åˆ°ç›‘æ§åˆ—è¡¨</h3>          <button className="modal-close" onClick={onClose}>Ã—</button>        </div>        <form onSubmit={handleSubmit} className="add-stock-form">          <div className="form-group">            <label htmlFor="stock-symbol">è‚¡ç¥¨ä»£ç æˆ–å…¬å¸åç§°</label>            <input              id="stock-symbol"              type="text"              placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç  (å¦‚: AAPL, GOOGL, TSLA) æˆ–å…¬å¸åç§°"              value={symbol}              onChange={(e) => setSymbol(e.target.value)}              autoFocus              autoComplete="off"            />            {isSearching && <div className="search-loading">æœç´¢ä¸­...</div>}            {error && <div className="search-error">{error}</div>}          </div>          {/* æœç´¢ç»“æœ */}          {searchResults.length > 0 && (            <div className="search-results">              <h4>æœç´¢ç»“æœ:</h4>              <ul className="results-list">                {searchResults.map((result, index) => (                  <li                    key={index}                    className="result-item"                    onClick={() => handleSelectStock(result.symbol)}                  >                    <div className="result-symbol">{result.symbol}</div>                    <div className="result-name">{result.name}</div>                    <div className="result-type">{result.type} â€¢ {result.region}</div>                  </li>                ))}              </ul>            </div>          )}          <div className="modal-actions">            <button type="button" className="cancel-btn" onClick={onClose}>              å–æ¶ˆ            </button>            <button              type="submit"              className="submit-btn"              disabled={!symbol.trim()}            >              æ·»åŠ             </button>          </div>        </form>        <div className="modal-tips">          <h4>ğŸ’¡ æç¤º:</h4>          <ul>            <li>è¾“å…¥ç¾è‚¡ä»£ç å¦‚ AAPL (è‹¹æœ)ã€GOOGL (è°·æ­Œ)ã€TSLA (ç‰¹æ–¯æ‹‰)</li>            <li>ä¹Ÿå¯ä»¥è¾“å…¥å…¬å¸åç§°è¿›è¡Œæœç´¢</li>            <li>ç³»ç»Ÿä¼šè‡ªåŠ¨è·å–æœ€æ–°çš„è‚¡ç¥¨æ•°æ®</li>          </ul>        </div>      </div>    </div>  );};